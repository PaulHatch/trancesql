name: Build

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
        DOTNET_CLI_TELEMETRY_OPTOUT: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      
      - name: Version
        id: version
        uses: paulhatch/semantic-version@v1.0.1
        with:
          format: "${major}.${minor}.${patch}.${increment}"
          tag_prefix: ""
      
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 3.1.100
      
      - name: Setup Nuget
        uses: nuget/setup-nuget@v1
      
      - name: Build
        run: "docker build --build-arg VERSION=${VERSION} -t trance/build ."
        env:
          VERSION: ${{ steps.version.outputs.version }}

      - name: Unit Tests
        run: docker run --rm trance/build --test

      - name: SQL Server Integration Test
        run: "docker-compose -f docker-compose.sqlserver.yml run test"
        env:
          IMAGE_TAG: trance/build

      - name: PostgreSQL Integration Test
        run: "docker-compose -f docker-compose.postgres.yml run test"
        env:
          IMAGE_TAG: trance/build

      - name: SQLite Integration Test
        run: "docker-compose -f docker-compose.sqlite.yml run test"
        env:
          IMAGE_TAG: trance/build

      - name: MySQL Integration Test
        run: "docker-compose -f docker-compose.mysql.yml run test"
        env:
          IMAGE_TAG: trance/build

      - name: Oracle Integration Test
        run: "docker-compose -f docker-compose.oracle.yml run test"
        env:
          IMAGE_TAG: trance/build
      